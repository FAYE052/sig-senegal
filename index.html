<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="theme-color" content="#2c3e50">
        <link rel="manifest" href="manifest.json">
        <link rel="icon" href="images/icon-192.png" sizes="192x192" type="image/png">
        <link rel="icon" href="images/icon-512.png" sizes="512x512" type="image/png">
        <link rel="icon" href="images/icon-192.svg" sizes="192x192">
        <link rel="apple-touch-icon" href="images/icon-192.png">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/MarkerCluster.css">
        <link rel="stylesheet" href="css/MarkerCluster.Default.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <style>
        body { margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Open Sans', sans-serif; overflow: hidden; }
        
        /* Navbar */
        #navbar {
            height: 55px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            padding: 0 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 2000;
            flex-shrink: 0;
        }
        #navbar .brand { font-size: 1.2em; font-weight: bold; margin-right: 30px; display: flex; align-items: center; white-space: nowrap; }
        #navbar .brand i { margin-right: 10px; color: #3498db; }
        #navbar .nav-items { display: flex; flex: 1; align-items: stretch; }
        #navbar .nav-item {
            color: #ecf0f1;
            text-decoration: none;
            margin-right: 0;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            padding: 0 15px;
            border-radius: 0;
            transition: background 0.3s;
            white-space: nowrap;
            height: 100%;
        }
        #navbar .nav-item:hover { background-color: #34495e; }
        #navbar .nav-item i { margin-right: 6px; }
        
        /* Main Layout */
        #main-container { flex: 1; display: flex; overflow: hidden; position: relative; }
        
        /* Sidebars */
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            transition: margin 0.3s ease;
            z-index: 1500;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .sidebar.collapsed { margin-left: -300px; }
        .sidebar-right { border-left: 1px solid #ddd; border-right: none; box-shadow: -2px 0 5px rgba(0,0,0,0.1); }
        .sidebar-right.collapsed { margin-right: -300px; }
        
        .sidebar-header {
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #2c3e50;
        }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* Map Wrapper */
        #map-wrapper { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        #map { flex: 1; width: 100%; height: 100%; }
        
        /* Custom Controls */
        #coords-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 15px;
            font-size: 12px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 25px;
            flex-shrink: 0;
        }
        
        #minimap-container {
            position: absolute;
            bottom: 40px;
            right: 20px;
            width: 150px;
            height: 110px;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        
        /* Leaflet Control Overrides */
        .leaflet-control-layers { box-shadow: none; border: none; background: none; }
        .leaflet-touch .leaflet-control-layers, .leaflet-touch .leaflet-bar { border: none; }
        .leaflet-control-measure { background: transparent; border: none; box-shadow: none; }
        .leaflet-control-measure .leaflet-control-measure-interaction { background: #fff; border-radius: 5px; box-shadow: 0 1px 5px rgba(0,0,0,0.4); }
        .leaflet-control-measure-toggle {
            width: 30px !important;
            height: 30px !important;
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #444;
            background-image: none !important;
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            text-decoration: none !important;
        }
        .leaflet-control-measure-toggle:hover { background-color: #f4f4f4; color: #444; }
        
        /* Dropdown Menus */
        .dropdown { position: relative; display: flex; align-items: center; height: 100%; cursor: pointer; }
        .dropdown:hover { background-color: #34495e; }
        .dropdown .nav-item { background: transparent; }
        .dropdown-content { display: none; position: absolute; background-color: #2c3e50; min-width: 180px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 3000; top: 100%; left: 0; border-radius: 0 0 4px 4px; }
        .dropdown-content a { color: #ecf0f1; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; font-size: 0.9em; }
        .dropdown-content a:hover { background-color: #34495e; }
        .dropdown:hover .dropdown-content { display: block; }
        .dropdown-divider { height: 1px; background-color: #34495e; margin: 4px 0; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 5px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: black; text-decoration: none; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group select, .form-group input { width: 100%; padding: 8px; box-sizing: border-box; }
        /* Query Results Table */
        #query-results table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-top: 10px; }
        #query-results th, #query-results td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #query-results th { background-color: #f2f2f2; }
        
        /* Fix for layer control inputs in sidebar */
        #layers-container input, #layers-container label { cursor: pointer; pointer-events: auto; }
        #layers-container .leaflet-control-layers-selector { margin-right: 5px; }
        </style>
        <title>Cartographie web des limites administratives du Senegal</title>
    </head>
    <body>
        <!-- Navbar -->
        <div id="navbar">
            <div class="brand"><i class="fas fa-globe-africa"></i> SIG Sénégal</div>
            <div class="nav-items">
                <a class="nav-item" onclick="resetView()"><i class="fas fa-home"></i> Accueil</a>
                <a class="nav-item" onclick="alert('Application Web SIG des limites administratives du Sénégal.\nRéalisée avec QGIS2WEB.')"><i class="fas fa-info-circle"></i> A propos</a>
                <a class="nav-item" onclick="toggleSidebar('left')"><i class="fas fa-layer-group"></i> Catalogue des données</a>
                <a class="nav-item" onclick="locateUser()"><i class="fas fa-location-arrow"></i> Localiser</a>
                <a id="install-btn" class="nav-item" style="display:none" onclick="promptInstall()"><i class="fas fa-download"></i> Installer</a>
                
                <div class="dropdown">
                    <a class="nav-item"><i class="fas fa-tools"></i> Outils <i class="fas fa-caret-down" style="margin-left: 5px;"></i></a>
                    <div class="dropdown-content">
                        <a onclick="map.zoomIn()"><i class="fas fa-search-plus"></i> Zoom +</a>
                        <a onclick="map.zoomOut()"><i class="fas fa-search-minus"></i> Zoom -</a>
                        <a onclick="toggleMeasure()"><i class="fas fa-ruler"></i> Mesure</a>
                        <a onclick="window.print()"><i class="fas fa-print"></i> Imprimer</a>
                        <div class="dropdown-divider"></div>
                        <a onclick="downloadData('geojson')"><i class="fas fa-file-code"></i> Télécharger GeoJSON</a>
                        <a onclick="downloadData('csv')"><i class="fas fa-file-csv"></i> Télécharger CSV</a>
                    </div>
                </div>
                <div class="dropdown">
                    <a class="nav-item"><i class="fas fa-filter"></i> Requête <i class="fas fa-caret-down" style="margin-left: 5px;"></i></a>
                    <div class="dropdown-content">
                        <a onclick="openSpatialQuery()">Requête Spatiale</a>
                        <a onclick="openAttributeQuery()">Requête Attributaire</a>
                    </div>
                </div>
            </div>
            <div class="nav-items" style="flex: 0;">
                <a class="nav-item" onclick="toggleSidebar('right')"><i class="fas fa-map"></i> Fonds & Légende</a>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-container">
            <!-- Left Sidebar (Layers) -->
            <div id="sidebar-left" class="sidebar">
                <div class="sidebar-header">
                    <span>Catalogue des données</span>
                    <i class="fas fa-times" onclick="toggleSidebar('left')" style="cursor:pointer;"></i>
                </div>
                <div class="sidebar-content">
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">Voici les différentes couches de données géographiques disponibles. Cliquez sur les cases pour les afficher ou les masquer.</p>
                    <div id="layers-container"></div>
                </div>
            </div>
            
            <!-- Map Area -->
            <div id="map-wrapper">
                <div id="map"></div>
                <div id="minimap-container"></div>
                <div id="coords-bar">
                    <span id="coords-display">Lat: 0.00000, Lng: 0.00000</span>
                    <span id="scale-display"></span>
                </div>
            </div>
            
            <!-- Right Sidebar (Basemaps & Legend) -->
            <div id="sidebar-right" class="sidebar sidebar-right">
                <div class="sidebar-header">
                    <span>Fonds de carte</span>
                    <i class="fas fa-times" onclick="toggleSidebar('right')" style="cursor:pointer;"></i>
                </div>
                <div id="basemaps-container" class="sidebar-content" style="flex: 0 0 auto; max-height: 200px;"></div>
                <div class="sidebar-header" style="border-top: 1px solid #ddd;">Légende</div>
                <div id="legend-container" class="sidebar-content"></div>
            </div>
        </div>

        <!-- Query Modal -->
        <div id="query-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeQueryModal()">&times;</span>
                <h2 id="query-title">Requête</h2>
                <div id="query-body"></div>
                <div id="query-results" style="margin-top:15px; max-height:200px; overflow-y:auto;"></div>
                <div style="margin-top:10px; text-align:right;">
                    <button id="query-btn" onclick="executeQuery()" style="padding:8px 16px; background-color:#2c3e50; color:white; border:none; border-radius:4px; cursor:pointer;">Exécuter</button>
                    <button id="query-clear-btn" onclick="clearQueryResults()" style="padding:8px 16px; background-color:#c0392b; color:white; border:none; border-radius:4px; cursor:pointer; display:none; margin-left: 5px;">Effacer</button>
                </div>
            </div>
        </div>

        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/leaflet.markercluster.js"></script>
        <script src="js/leaflet-search.js"></script>
        <script src="data/Region_1.js"></script>
        <script src="data/Departement_2.js"></script>
        <script src="data/Arrondissement_3.js"></script>
        <script src="data/Routes_4.js"></script>
        <script src="data/localites_5.js"></script>
        <script>
        var highlightLayer;
        function highlightFeature(e) {
            highlightLayer = e.target;

            if (e.target.feature.geometry.type === 'LineString' || e.target.feature.geometry.type === 'MultiLineString') {
              highlightLayer.setStyle({
                color: 'rgba(255, 255, 0, 1.00)',
              });
            } else {
              highlightLayer.setStyle({
                fillColor: 'rgba(255, 255, 0, 1.00)',
                fillOpacity: 1
              });
            }
            highlightLayer.openPopup();
        }
        var map = L.map('map', {
            zoomControl:true, maxZoom:20, minZoom:1, attributionControl: true
        })
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        // remove popup's row if "visible-with-data"
        function removeEmptyRowsFromPopupContent(content, feature) {
         var tempDiv = document.createElement('div');
         tempDiv.innerHTML = content;
         var rows = tempDiv.querySelectorAll('tr');
         for (var i = 0; i < rows.length; i++) {
             var td = rows[i].querySelector('td.visible-with-data');
             var key = td ? td.id : '';
             if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                 rows[i].parentNode.removeChild(rows[i]);
             }
         }
         return tempDiv.innerHTML;
        }
        // modify popup if contains media
        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.update();
                    }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio');
                    audio.controls = true;
                    audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video');
                    video.controls = true;
                    video.src = src;
                    video.style.width = "400px";
                    video.style.height = "300px";
                    video.style.maxHeight = "60vh";
                    video.style.maxWidth = "60vw";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    // Aggiorna il popup quando il video carica i metadati
                    video.addEventListener('loadedmetadata', function() {
                        popup.update();
                    });
                    setTimeout(function() {
                        popup.setContent(tempDiv.innerHTML);
                        popup.update();
                    }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        // Removed default title, abstract and zoom controls to use custom UI
        
        L.control.locate({locateOptions: {maxZoom: 19}, position: 'topleft'}).addTo(map);
        
        var measureControl = new L.Control.Measure({
            position: 'topleft',
            primaryLengthUnit: 'meters',
            secondaryLengthUnit: 'kilometers',
            primaryAreaUnit: 'sqmeters',
            secondaryAreaUnit: 'hectares'
        });
        measureControl.addTo(map);
        
        var bounds_group = new L.featureGroup([]);
        function setBounds() {
            if (bounds_group.getLayers().length) {
                map.fitBounds(bounds_group.getBounds());
            }
        }
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 20,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        layer_OpenStreetMap_0;
        map.addLayer(layer_OpenStreetMap_0);
        function pop_Region_1(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2"><strong>Code</strong><br />' + (feature.properties['Code'] !== null ? autolinker.link(String(feature.properties['Code']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2"><strong>Région</strong><br />' + (feature.properties['Région'] !== null ? autolinker.link(String(feature.properties['Région']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Region_1_0(feature) {
            switch(String(feature.properties['Région'])) {
                case 'DAKAR':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(90,240,21,1.0)',
                interactive: true,
            }
                    break;
                case 'DIOURBEL':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(233,178,130,1.0)',
                interactive: true,
            }
                    break;
                case 'FATICK':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(239,67,54,1.0)',
                interactive: true,
            }
                    break;
                case 'KAFFRINE':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(184,209,120,1.0)',
                interactive: true,
            }
                    break;
                case 'KAOLACK':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(218,128,194,1.0)',
                interactive: true,
            }
                    break;
                case 'KEDOUGOU':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(99,144,234,1.0)',
                interactive: true,
            }
                    break;
                case 'KOLDA':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(131,43,231,1.0)',
                interactive: true,
            }
                    break;
                case 'LOUGA':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(215,89,131,1.0)',
                interactive: true,
            }
                    break;
                case 'MATAM':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(217,67,240,1.0)',
                interactive: true,
            }
                    break;
                case 'SAINT-LOUIS':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(60,215,197,1.0)',
                interactive: true,
            }
                    break;
                case 'SEDHIOU':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(113,185,214,1.0)',
                interactive: true,
            }
                    break;
                case 'TAMBACOUNDA':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(64,201,130,1.0)',
                interactive: true,
            }
                    break;
                case 'THIES':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(222,204,84,1.0)',
                interactive: true,
            }
                    break;
                case 'ZIGUINCHOR':
                    return {
                pane: 'pane_Region_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0, 
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(72,219,84,1.0)',
                interactive: true,
            }
                    break;
            }
        }
        map.createPane('pane_Region_1');
        map.getPane('pane_Region_1').style.zIndex = 401;
        map.getPane('pane_Region_1').style['mix-blend-mode'] = 'normal';
        var layer_Region_1 = new L.geoJson(json_Region_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Region_1',
            layerName: 'layer_Region_1',
            pane: 'pane_Region_1',
            onEachFeature: pop_Region_1,
            style: style_Region_1_0,
        });
        bounds_group.addLayer(layer_Region_1);
        map.addLayer(layer_Region_1);
        function pop_Departement_2(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">cod_reg</th>\
                        <td>' + (feature.properties['cod_reg'] !== null ? autolinker.link(String(feature.properties['cod_reg']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">reg</th>\
                        <td>' + (feature.properties['reg'] !== null ? autolinker.link(String(feature.properties['reg']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">dept</th>\
                        <td>' + (feature.properties['dept'] !== null ? autolinker.link(String(feature.properties['dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">cod_dept</th>\
                        <td>' + (feature.properties['cod_dept'] !== null ? autolinker.link(String(feature.properties['cod_dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">ccod_dept</th>\
                        <td>' + (feature.properties['ccod_dept'] !== null ? autolinker.link(String(feature.properties['ccod_dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Departement_2_0() {
            return {
                pane: 'pane_Departement_2',
                opacity: 1,
                color: 'rgba(228,26,28,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 4.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_Departement_2');
        map.getPane('pane_Departement_2').style.zIndex = 402;
        map.getPane('pane_Departement_2').style['mix-blend-mode'] = 'normal';
        var layer_Departement_2 = new L.geoJson(json_Departement_2, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Departement_2',
            layerName: 'layer_Departement_2',
            pane: 'pane_Departement_2',
            onEachFeature: pop_Departement_2,
            style: style_Departement_2_0,
        });
        bounds_group.addLayer(layer_Departement_2);
        map.addLayer(layer_Departement_2);
        function pop_Arrondissement_3(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">cod_reg</th>\
                        <td>' + (feature.properties['cod_reg'] !== null ? autolinker.link(String(feature.properties['cod_reg']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">reg</th>\
                        <td>' + (feature.properties['reg'] !== null ? autolinker.link(String(feature.properties['reg']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">dept</th>\
                        <td>' + (feature.properties['dept'] !== null ? autolinker.link(String(feature.properties['dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">cod_dept</th>\
                        <td>' + (feature.properties['cod_dept'] !== null ? autolinker.link(String(feature.properties['cod_dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">ccod_dept</th>\
                        <td>' + (feature.properties['ccod_dept'] !== null ? autolinker.link(String(feature.properties['ccod_dept']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">cav</th>\
                        <td>' + (feature.properties['cav'] !== null ? autolinker.link(String(feature.properties['cav']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">ccod_cav</th>\
                        <td>' + (feature.properties['ccod_cav'] !== null ? autolinker.link(String(feature.properties['ccod_cav']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">arr</th>\
                        <td>' + (feature.properties['arr'] !== null ? autolinker.link(String(feature.properties['arr']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Arrondissement_3_0() {
            return {
                pane: 'pane_Arrondissement_3',
                opacity: 1,
                color: 'rgba(74,153,175,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: true,
            }
        }
        map.createPane('pane_Arrondissement_3');
        map.getPane('pane_Arrondissement_3').style.zIndex = 403;
        map.getPane('pane_Arrondissement_3').style['mix-blend-mode'] = 'normal';
        var layer_Arrondissement_3 = new L.geoJson(json_Arrondissement_3, {
            attribution: '',
            interactive: true,
            dataVar: 'json_Arrondissement_3',
            layerName: 'layer_Arrondissement_3',
            pane: 'pane_Arrondissement_3',
            onEachFeature: pop_Arrondissement_3,
            style: style_Arrondissement_3_0,
        });
        bounds_group.addLayer(layer_Arrondissement_3);
        map.addLayer(layer_Arrondissement_3);
        function pop_Routes_4(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['FNODE_'] !== null ? autolinker.link(String(feature.properties['FNODE_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['TNODE_'] !== null ? autolinker.link(String(feature.properties['TNODE_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['LPOLY_'] !== null ? autolinker.link(String(feature.properties['LPOLY_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['RPOLY_'] !== null ? autolinker.link(String(feature.properties['RPOLY_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['LONGUEUR'] !== null ? autolinker.link(String(feature.properties['LONGUEUR']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ROUTESA3_'] !== null ? autolinker.link(String(feature.properties['ROUTESA3_']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['ROUTESA3_I'] !== null ? autolinker.link(String(feature.properties['ROUTESA3_I']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['CODE'] !== null ? autolinker.link(String(feature.properties['CODE']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <td colspan="2">' + (feature.properties['FONCTION'] !== null ? autolinker.link(String(feature.properties['FONCTION']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_Routes_4_0(feature) {
            switch(String(feature.properties['FONCTION'])) {
                case 'Autres pistes':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(218,223,222,1.0)',
                dashArray: '4.0,2.0',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Autres routes':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(165,166,166,1.0)',
                dashArray: '4.0,2.0,1.0,2.0,1.0,2.0',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Chemin de fer':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(0,0,0,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 2.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Digues':
                    return {
                pane: 'pane_Routes_4',
                interactive: false,
            }
                    break;
                case 'Piste automobile':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(72,36,42,1.0)',
                dashArray: '1.0,2.0',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Piste secondaire':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(207,208,224,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Route principale':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(219,30,42,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Route principale à 2 voies':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(54,130,214,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 3.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                case 'Route principale à 4 voies':
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(227,26,28,1.0)',
                dashArray: '',
                lineCap: 'round',
                lineJoin: 'round',
                weight: 5.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
                default:
                    return {
                pane: 'pane_Routes_4',
                opacity: 1,
                color: 'rgba(136,236,81,1.0)',
                dashArray: '',
                lineCap: 'square',
                lineJoin: 'bevel',
                weight: 1.0,
                fillOpacity: 0,
                interactive: false,
            }
                    break;
            }
        }
        map.createPane('pane_Routes_4');
        map.getPane('pane_Routes_4').style.zIndex = 404;
        map.getPane('pane_Routes_4').style['mix-blend-mode'] = 'normal';
        var layer_Routes_4 = new L.geoJson(json_Routes_4, {
            attribution: '',
            interactive: false,
            dataVar: 'json_Routes_4',
            layerName: 'layer_Routes_4',
            pane: 'pane_Routes_4',
            onEachFeature: pop_Routes_4,
            style: style_Routes_4_0,
        });
        bounds_group.addLayer(layer_Routes_4);
        map.addLayer(layer_Routes_4);
        function pop_localites_5(feature, layer) {
            layer.on({
                mouseout: function(e) {
                    for (var i in e.target._eventParents) {
                        if (typeof e.target._eventParents[i].resetStyle === 'function') {
                            e.target._eventParents[i].resetStyle(e.target);
                        }
                    }
                    if (typeof layer.closePopup == 'function') {
                        layer.closePopup();
                    } else {
                        layer.eachLayer(function(feature){
                            feature.closePopup()
                        });
                    }
                },
                mouseover: highlightFeature,
            });
            var popupContent = '<table>\
                    <tr>\
                        <th scope="row">NOM</th>\
                        <td>' + (feature.properties['NOM'] !== null ? autolinker.link(String(feature.properties['NOM']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">NUM_VILLAG</th>\
                        <td>' + (feature.properties['NUM_VILLAG'] !== null ? autolinker.link(String(feature.properties['NUM_VILLAG']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">X_UTM</th>\
                        <td>' + (feature.properties['X_UTM'] !== null ? autolinker.link(String(feature.properties['X_UTM']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                    <tr>\
                        <th scope="row">Y_UTM</th>\
                        <td>' + (feature.properties['Y_UTM'] !== null ? autolinker.link(String(feature.properties['Y_UTM']).replace(/'/g, '\'').toLocaleString()) : '') + '</td>\
                    </tr>\
                </table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
			layer.on('popupopen', function(e) {
				addClassToPopupIfMedia(content, e.popup);
			});
			layer.bindPopup(content, { maxHeight: 400 });
        }

        function style_localites_5_0() {
            return {
                pane: 'pane_localites_5',
                radius: 4.0,
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1,
                fill: true,
                fillOpacity: 1,
                fillColor: 'rgba(141,90,153,1.0)',
                interactive: true,
            }
        }
        map.createPane('pane_localites_5');
        map.getPane('pane_localites_5').style.zIndex = 405;
        map.getPane('pane_localites_5').style['mix-blend-mode'] = 'normal';
        var layer_localites_5 = new L.geoJson(json_localites_5, {
            attribution: '',
            interactive: true,
            dataVar: 'json_localites_5',
            layerName: 'layer_localites_5',
            pane: 'pane_localites_5',
            onEachFeature: pop_localites_5,
            pointToLayer: function (feature, latlng) {
                var context = {
                    feature: feature,
                    variables: {}
                };
                return L.circleMarker(latlng, style_localites_5_0(feature));
            },
        });
        var cluster_localites_5 = new L.MarkerClusterGroup({showCoverageOnHover: false,
            spiderfyDistanceMultiplier: 2});
        cluster_localites_5.addLayer(layer_localites_5);

        bounds_group.addLayer(layer_localites_5);
        cluster_localites_5.addTo(map);
        var overlaysTree = [
            {label: 'Localites', layer: cluster_localites_5},
            {label: 'Routes', layer: layer_Routes_4},
            {label: 'Arrondissement', layer: layer_Arrondissement_3},
            {label: 'Departement', layer: layer_Departement_2},
            {label: 'Region', layer: layer_Region_1},
            ]
        
        var overlays = {};
        for (var i = 0; i < overlaysTree.length; i++) {
            overlays[overlaysTree[i].label] = overlaysTree[i].layer;
        }
        // Separate Overlays and Basemaps controls
        var overlayControl = L.control.layers(null, overlays, { collapsed: false });
        overlayControl.addTo(map);
        document.getElementById('layers-container').appendChild(overlayControl.getContainer());
        
        var baseMaps = {
            "OpenStreetMap": layer_OpenStreetMap_0,
            "Google Satellite Hybrid": L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                opacity: 1.0, attribution: 'Google'
            }),
            "CartoDB Dark Matter": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            })
        };
        var basemapControl = L.control.layers(baseMaps, null, { collapsed: false });
        basemapControl.addTo(map);
        document.getElementById('basemaps-container').appendChild(basemapControl.getContainer());

        setBounds();
        var i = 0;
        layer_Region_1.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['Région'] !== null?String('<div style="color: #323232; font-size: 10pt; font-family: \'Noto Serif\', sans-serif;">' + layer.feature.properties['Région']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_Region_1'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var i = 0;
        layer_localites_5.eachLayer(function(layer) {
            var context = {
                feature: layer.feature,
                variables: {}
            };
            layer.bindTooltip((layer.feature.properties['NOM'] !== null?String('<div style="color: #323232; font-size: 10pt; font-family: \'Open Sans\', sans-serif;">' + layer.feature.properties['NOM']) + '</div>':''), {permanent: true, offset: [-0, -16], className: 'css_localites_5'});
            labels.push(layer);
            totalMarkers += 1;
              layer.added = true;
              addLabel(layer, i);
              i++;
        });
        var searchControl = new L.Control.Search({
            layer: cluster_localites_5,
            initial: false,
            hideMarkerOnCollapse: true,
            propertyName: 'NOM',
            textPlaceholder: 'Rechercher une localité ou une adresse...',
            sourceData: function(text, callResponse) {
                var results = {};
                // 1. Search in localites layer
                var regex = new RegExp(String(text).replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'i');
                layer_localites_5.eachLayer(function(layer) {
                    if (layer.feature.properties && layer.feature.properties.NOM && regex.test(layer.feature.properties.NOM)) {
                        results[layer.feature.properties.NOM] = layer;
                    }
                });
                
                // 2. Search Nominatim
                var url = "https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(text);
                var controller = new AbortController();
                var signal = controller.signal;
                
                fetch(url, { signal: signal })
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(function(item) {
                            if (!results[item.display_name]) {
                                results[item.display_name] = L.latLng(item.lat, item.lon);
                            }
                        });
                        callResponse(results);
                    })
                    .catch(function(error) {
                        if (error.name !== 'AbortError') {
                            console.error("Nominatim search error:", error);
                        }
                        callResponse(results);
                    });
                
                return { abort: function() { controller.abort(); } };
            },
            filterData: function(text, records) {
                return records;
            },
            marker: {
                icon: true,
                animate: true,
                circle: {
                    radius: 20,
                    weight: 3,
                    color: '#e03',
                    stroke: true,
                    fill: false
                }
            }
        });
        map.addControl(searchControl);
        
        var searchButtons = document.getElementsByClassName('search-button');
        if (searchButtons.length > 0) {
            for (var k = 0; k < searchButtons.length; k++) {
                searchButtons[k].className += ' fa fa-binoculars';
            }
        }
        
        resetLabels([layer_Region_1,layer_localites_5]);
        map.on("zoomend", function(){
            resetLabels([layer_Region_1,layer_localites_5]);
        });
        map.on("layeradd", function(){
            resetLabels([layer_Region_1,layer_localites_5]);
        });
        map.on("layerremove", function(){
            resetLabels([layer_Region_1,layer_localites_5]);
        });
        
        // --- Custom Logic ---
        
        // Toggle Sidebars
        function toggleSidebar(side) {
            var el = document.getElementById('sidebar-' + side);
            if (el.classList.contains('collapsed')) {
                el.classList.remove('collapsed');
                if(side === 'left') el.style.marginLeft = '0';
                if(side === 'right') el.style.marginRight = '0';
            } else {
                el.classList.add('collapsed');
                if(side === 'left') el.style.marginLeft = '-300px';
                if(side === 'right') el.style.marginRight = '-300px';
            }
            setTimeout(function() { map.invalidateSize(); }, 300);
        }
        
        // Reset View
        function resetView() {
            if (bounds_group.getLayers().length) {
                map.fitBounds(bounds_group.getBounds());
            }
        }
        
        // Toggle Measure
        function toggleMeasure() {
            var btn = document.querySelector('.leaflet-control-measure-toggle');
            if(btn) btn.click();
        }
        
        // Download Data
        function downloadData(format) {
            if (format === 'geojson') {
                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(json_localites_5));
                downloadFile(dataStr, "localites.geojson");
            } else if (format === 'csv') {
                var csv = geoJSONToCSV(json_localites_5);
                var dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
                downloadFile(dataStr, "localites.csv");
            } else if (format === 'shp') {
                alert("Le téléchargement en Shapefile nécessite une librairie externe.");
            }
        }
        
        function geoJSONToCSV(geojson) {
            if (!geojson.features || geojson.features.length === 0) return "";
            var props = Object.keys(geojson.features[0].properties);
            var csv = props.join(",") + "\n";
            geojson.features.forEach(function(feature) {
                var row = props.map(function(prop) {
                    return '"' + (feature.properties[prop] || "").toString().replace(/"/g, '""') + '"';
                });
                csv += row.join(",") + "\n";
            });
            return csv;
        }
        
        function downloadFile(dataStr, fileName) {
            var downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href",     dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        // MiniMap
        var miniMap = L.map('minimap-container', {
            zoomControl: false,
            attributionControl: false,
            layers: [L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png')]
        });
        miniMap.setView(map.getCenter(), Math.max(0, map.getZoom() - 4));
        map.on('move', function() {
            miniMap.setView(map.getCenter(), Math.max(0, map.getZoom() - 4));
        });
        
        // Coordinates
        map.on('mousemove', function(e) {
            document.getElementById('coords-display').innerHTML = "Lat: " + e.latlng.lat.toFixed(5) + " Lng: " + e.latlng.lng.toFixed(5);
        });
        
        // Scale
        L.control.scale({position: 'bottomleft', maxWidth: 150}).addTo(map);
        // Move scale to custom bar if needed, but default bottomleft is fine on map
        
        // Build Legend from overlaysTree
        function getLegendHtml(layer) {
            if (layer === layer_Region_1) {
                var categories = {};
                json_Region_1.features.forEach(function(f) {
                    var val = f.properties['Région'];
                    if (!categories[val]) {
                        categories[val] = style_Region_1_0(f).fillColor;
                    }
                });
                var html = '';
                for (var cat in categories) {
                    html += '<div style="display:flex;align-items:center;margin-top:2px;"><span style="display:inline-block;width:12px;height:12px;background:' + categories[cat] + ';border:1px solid #232323;margin-right:5px;"></span>' + cat + '</div>';
                }
                return html;
            } else if (layer === layer_Departement_2) {
                var style = style_Departement_2_0();
                return '<div style="display:flex;align-items:center;margin-top:2px;"><span style="display:inline-block;width:12px;height:12px;border:4px solid ' + style.color + ';margin-right:5px;"></span>Departement</div>';
            } else if (layer === layer_Arrondissement_3) {
                var style = style_Arrondissement_3_0();
                return '<div style="display:flex;align-items:center;margin-top:2px;"><span style="display:inline-block;width:12px;height:12px;border:1px solid ' + style.color + ';margin-right:5px;"></span>Arrondissement</div>';
            } else if (layer === layer_Routes_4) {
                var categories = {};
                json_Routes_4.features.forEach(function(f) {
                    var val = f.properties['FONCTION'];
                    if (!categories[val]) {
                        categories[val] = style_Routes_4_0(f).color;
                    }
                });
                var html = '';
                for (var cat in categories) {
                    html += '<div style="display:flex;align-items:center;margin-top:2px;"><span style="display:inline-block;width:12px;height:2px;background:' + categories[cat] + ';margin-right:5px;"></span>' + cat + '</div>';
                }
                return html;
            } else if (layer === cluster_localites_5) {
                var style = style_localites_5_0();
                return '<div style="display:flex;align-items:center;margin-top:2px;"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:' + style.fillColor + ';border:1px solid ' + style.color + ';margin-right:5px;"></span>Localites</div>';
            }
            return '';
        }

        function buildLegend(tree, container) {
            tree.forEach(function(item) {
                if (item.layer) {
                    var div = document.createElement('div');
                    div.className = 'legend-item';
                    div.style.marginBottom = "10px";
                    
                    var title = document.createElement('div');
                    title.style.fontWeight = "bold";
                    title.innerHTML = item.label;
                    div.appendChild(title);
                    
                    var legendContent = document.createElement('div');
                    legendContent.innerHTML = getLegendHtml(item.layer);
                    legendContent.style.marginLeft = "10px";
                    div.appendChild(legendContent);
                    
                    container.appendChild(div);
                }
                if (item.children) {
                    buildLegend(item.children, container);
                }
            });
        }
        buildLegend(overlaysTree, document.getElementById('legend-container'));
        
        // Query Logic
        var queryableLayers = {
            "Localites": layer_localites_5,
            "Routes": layer_Routes_4,
            "Arrondissement": layer_Arrondissement_3,
            "Departement": layer_Departement_2,
            "Region": layer_Region_1
        };

        var currentQueryType = "";
        var spatialQueryClickHander = null;
        var currentSpatialLayer = null;

        function closeQueryModal() {
            document.getElementById('query-modal').style.display = "none";
            if (spatialQueryClickHander) {
                map.off('click', spatialQueryClickHander);
                spatialQueryClickHander = null;
                map.getContainer().style.cursor = '';
            }
        }

        function clearQueryResults() {
            if (currentSpatialLayer) {
                map.removeLayer(currentSpatialLayer);
                currentSpatialLayer = null;
            }
            for (var key in queryableLayers) {
                queryableLayers[key].eachLayer(function(l) { queryableLayers[key].resetStyle(l); });
            }
            document.getElementById('query-results').innerHTML = "";
            document.getElementById('query-clear-btn').style.display = "none";
        }

        function openAttributeQuery() {
            currentQueryType = "attribute";
            var modal = document.getElementById('query-modal');
            var title = document.getElementById('query-title');
            var body = document.getElementById('query-body');
            var btn = document.getElementById('query-btn');
            clearQueryResults();
            
            title.innerText = "Requête Attributaire";
            btn.style.display = "inline-block";
            btn.innerText = "Exécuter";
            
            var html = '<div class="form-group"><label>Couche:</label><select id="query-layer" onchange="updateQueryFields()">';
            for (var key in queryableLayers) {
                html += '<option value="' + key + '">' + key + '</option>';
            }
            html += '</select></div>';
            
            html += '<div class="form-group"><label>Champ:</label><select id="query-field"></select></div>';
            html += '<div class="form-group"><label>Opérateur:</label><select id="query-operator"><option value="=">Egal à</option><option value="contains">Contient</option><option value=">">Supérieur à</option><option value="<">Inférieur à</option></select></div>';
            html += '<div class="form-group"><label>Valeur:</label><input type="text" id="query-value"></div>';
            
            body.innerHTML = html;
            modal.style.display = "block";
            updateQueryFields();
        }

        window.updateQueryFields = function() {
            var layerName = document.getElementById('query-layer').value;
            var layer = queryableLayers[layerName];
            var fieldsSelect = document.getElementById('query-field');
            fieldsSelect.innerHTML = "";
            
            if (layer && layer.toGeoJSON().features.length > 0) {
                var props = layer.toGeoJSON().features[0].properties;
                for (var key in props) {
                    var option = document.createElement('option');
                    option.value = key;
                    option.text = key;
                    fieldsSelect.appendChild(option);
                }
            }
        };

        function openSpatialQuery() {
            currentQueryType = "spatial";
            var modal = document.getElementById('query-modal');
            var title = document.getElementById('query-title');
            var body = document.getElementById('query-body');
            var btn = document.getElementById('query-btn');
            
            clearQueryResults();
            title.innerText = "Requête Spatiale";
            btn.style.display = "inline-block";
            btn.innerText = "Sélectionner sur la carte";
            
            var html = '<div class="form-group"><label>Couche cible:</label><select id="spatial-layer">';
            for (var key in queryableLayers) {
                html += '<option value="' + key + '">' + key + '</option>';
            }
            html += '</select></div>';
            html += '<div class="form-group"><label>Distance (mètres):</label><input type="number" id="spatial-distance" value="1000"></div>';
            
            body.innerHTML = html;
            modal.style.display = "block";
        }

        function executeQuery() {
            if (currentQueryType === "attribute") {
                var layerName = document.getElementById('query-layer').value;
                var field = document.getElementById('query-field').value;
                var operator = document.getElementById('query-operator').value;
                var value = document.getElementById('query-value').value;
                
                var layer = queryableLayers[layerName];
                
                // Reset styles
                layer.eachLayer(function(l) { layer.resetStyle(l); });
                
                var found = false;
                layer.eachLayer(function(l) {
                    var props = l.feature.properties;
                    var val = props[field];
                    var match = false;
                    
                    if (operator === "=") match = (val == value);
                    else if (operator === "contains") match = (String(val).toLowerCase().includes(String(value).toLowerCase()));
                    else if (operator === ">") match = (val > value);
                    else if (operator === "<") match = (val < value);
                    
                    if (match) {
                        highlightFeature({target: l});
                        found = true;
                    }
                });
                
                if (!found) alert("Aucun résultat trouvé.");
                closeQueryModal();
            } else if (currentQueryType === "spatial") {
                document.getElementById('query-modal').style.display = "none";
                
                if (spatialQueryClickHander) map.off('click', spatialQueryClickHander);
                
                spatialQueryClickHander = function(e) {
                    executeSpatialQuery(e.latlng);
                };
                map.on('click', spatialQueryClickHander);
                map.getContainer().style.cursor = 'crosshair';
            }
        }

        function isPointInPolygon(latlng, layer) {
            var x = latlng.lng, y = latlng.lat;
            var polys = [];
            
            if (layer.feature.geometry.type === 'Polygon') {
                polys.push(layer.feature.geometry.coordinates);
            } else if (layer.feature.geometry.type === 'MultiPolygon') {
                polys = layer.feature.geometry.coordinates;
            }

            for (var k = 0; k < polys.length; k++) {
                var inside = false;
                var ring = polys[k][0];
                for (var i = 0, j = ring.length - 1; i < ring.length; j = i++) {
                    var xi = ring[i][0], yi = ring[i][1];
                    var xj = ring[j][0], yj = ring[j][1];
                    
                    var intersect = ((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
                    if (intersect) inside = !inside;
                }
                if (inside) return true;
            }
            return false;
        }

        function executeSpatialQuery(latlng) {
            clearQueryResults();
            var layerName = document.getElementById('spatial-layer').value;
            var distance = parseFloat(document.getElementById('spatial-distance').value);
            var layer = queryableLayers[layerName];
            
            // Show search circle
            currentSpatialLayer = L.circle(latlng, {radius: distance, color: 'blue', fillOpacity: 0.1}).addTo(map);
            map.fitBounds(currentSpatialLayer.getBounds());
            
            var results = [];
            var found = false;
            layer.eachLayer(function(l) {
                var layerLatLng;
                if (l.getLatLng) {
                    layerLatLng = l.getLatLng();
                } else if (l.getBounds) {
                    layerLatLng = l.getBounds().getCenter();
                }
                
                if (layerLatLng) {
                    var d = latlng.distanceTo(layerLatLng);
                    var isInside = false;
                    if (l.feature && (l.feature.geometry.type === 'Polygon' || l.feature.geometry.type === 'MultiPolygon')) {
                        isInside = isPointInPolygon(latlng, l);
                    }
                    
                    if (d <= distance || isInside) {
                        highlightFeature({target: l});
                        found = true;
                        results.push(l.feature.properties);
                    }
                }
            });
            
            var modal = document.getElementById('query-modal');
            var resultsContainer = document.getElementById('query-results');
            var clearBtn = document.getElementById('query-clear-btn');
            
            if (found) {
                var excludedKeys = ['ENTITY', 'LAYER', 'ELEVATION', 'THICKNESS', 'COLOR', 'styleUrl', 'styleHash'];
                var table = '<table><thead><tr>';
                var keys = Object.keys(results[0]).filter(function(k) { return excludedKeys.indexOf(k) === -1; });
                keys.forEach(function(k) { table += '<th>' + k + '</th>'; });
                table += '</tr></thead><tbody>';
                
                results.forEach(function(props) {
                    table += '<tr>';
                    keys.forEach(function(k) { table += '<td>' + (props[k] || '') + '</td>'; });
                    table += '</tr>';
                });
                table += '</tbody></table>';
                
                resultsContainer.innerHTML = '<p>' + results.length + ' résultat(s) trouvé(s).</p>' + table;
                clearBtn.style.display = "inline-block";
                modal.style.display = "block";
                map.getContainer().style.cursor = '';
            } else {
                alert("Aucune entité trouvée dans la zone.");
                modal.style.display = "block";
            }
        }

        // --- PWA: service worker registration & install prompt handler ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(function(reg) { console.log('Service Worker registered.', reg); }).catch(function(err) { console.warn('Service Worker registration failed:', err); });
        }

        var deferredPrompt;
        window.addEventListener('beforeinstallprompt', function(e) {
            e.preventDefault();
            deferredPrompt = e;
            var btn = document.getElementById('install-btn');
            if (btn) btn.style.display = 'inline-flex';
        });

        function promptInstall() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then(function(choiceResult) {
                if (choiceResult.outcome === 'accepted') {
                    var btn = document.getElementById('install-btn');
                    if (btn) btn.style.display = 'none';
                }
                deferredPrompt = null;
            });
        }

        // --- Geolocation helpers ---
        function locateUser() {
            if (!navigator.geolocation) {
                alert('Géolocalisation non supportée par ce navigateur.');
                return;
            }
            map.locate({setView: true, maxZoom: 16});
        }

        map.on('locationfound', function(e) {
            var latlng = e.latlng || (e.latitude && e.longitude && L.latLng(e.latitude, e.longitude));
            if (!latlng) return;
            document.getElementById('coords-display').textContent = 'Lat: ' + latlng.lat.toFixed(5) + ', Lng: ' + latlng.lng.toFixed(5);
            L.circle(latlng, {radius: e.accuracy || 30, color: '#3388ff', fillOpacity: 0.1}).addTo(map);
        });

        map.on('locationerror', function(e) {
            console.warn('Geolocation error', e);
            alert('Erreur de géolocalisation: ' + (e.message || e.code || 'Erreur inconnue'));
        });
        </script>
    </body>
</html>
